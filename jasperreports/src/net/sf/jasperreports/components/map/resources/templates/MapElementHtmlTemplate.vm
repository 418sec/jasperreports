<div 
#if(${xhtml})
	style='position: absolute; left: ${elementX}; top: ${elementY}; width: ${elementWidth}px; height: ${elementHeight}px;
#else
	style='width: ${elementWidth}px; height: ${elementHeight}px;
#end
	#if(${backgroundColor}) 
		background-color: \#${backgroundColor};
	#end
'>
	<div id='${mapCanvasId}' style='width: 100%; height: 100%; overflow: auto'></div>
</div>

#if (${gotReportContext})
	<script class='jasperreports' type='text/javascript'>
		jasperreports.global.appendScriptElementToDOM('_mapScript', '${resourceMapJs}', 'jasperreports.map.initGoogleMaps', ['${language}']);
		var markers = ${markerList};
		jasperreports.events.subscribeToEvent({name: 'jasperreports.map.init', callback: 'jasperreports.map.showMap', args: ['${mapCanvasId}', ${latitude}, ${longitude}, ${zoom}, '${mapType}', markers]});
	</script>
#else
	#if (${exporterFirstAttempt})
		#if(${language})
			<script class='jasperreports' src='http://maps.google.com/maps/api/js?sensor=false&language=${language}'></script>
		#else
			<script class='jasperreports' src='http://maps.google.com/maps/api/js?sensor=false'></script>
		#end
	#end
	<script class='jasperreports' type='text/javascript'>
		(function () {
			var map = new google.maps.Map(document.getElementById('${mapCanvasId}'), {
						zoom: ${zoom},
						center: new google.maps.LatLng(${latitude}, ${longitude}), 
						mapTypeId: google.maps.MapTypeId.${mapType}
					});
			var markers = ${markerList};
			if(markers){
				var j;
				for (var i = 0; i < markers.length; i++) {
				    var markerProps = markers[i];
				    var markerLatLng = new google.maps.LatLng(markerProps['latitude'], markerProps['longitude']);
				    var markerOptions = {
					        position: markerLatLng,
					        map: map
					    };
				    if(markerProps['icon.url'] && markerProps['icon.url'].length > 0) {
				    	var width, height, originX, originY, anchorX, anchorY;
				    	var iconSize;
				    	var iconOrigin, iconAnchor;
				    	var iconUrl = markerProps['icon.url'];
				    	
				    	if(markerProps['icon.width']) {
				    		width = new Number(markerProps['icon.width']);
				    		height = 0;
				    	}
				    	if(markerProps['icon.height']) {
				    		height = new Number(markerProps['icon.height']);
				    		if(!width) {
				    			width = 0;
				    		}
				    	}
				    	if(markerProps['icon.origin.x']) {
				    		originX = new Number(markerProps['icon.origin.x']);
				    		originY = 0;
				    	}
				    	if(markerProps['icon.origin.y']) {
				    		originY = new Number(markerProps['icon.origin.y']);
				    		if(!originX) {
				    			originX = 0;
				    		}
				    	}
				    	if(markerProps['icon.anchor.x']) {
				    		anchorX = new Number(markerProps['icon.anchor.x']);
				    		anchorY = 0;
				    	}
				    	if(markerProps['icon.anchor.y']) {
				    		anchorY = new Number(markerProps['icon.anchor.y']);
				    		if(!anchorX) {
				    			anchorX = 0;
				    		}
				    	}
			    		if(width || height) {
			    			iconSize = new google.maps.Size(width,height);
			    		}
			    		if(originX || originY) {
			    			iconOrigin = new google.maps.Point(originX,originY);
			    		}
			    		if(anchorX || anchorY) {
			    			iconAnchor = new google.maps.Point(anchorX,anchorY);
			    		}
			    		
			    		var customIcon = {
				    		url: iconUrl,
				    		size: iconSize,
				    		origin: iconOrigin,
				    		anchor: iconAnchor
				    	};
				    	markerOptions['icon'] = customIcon;
				    }
				    
				    if(markerProps['shadow.url'] && markerProps['shadow.url'].length > 0) {
				    	var width, height, originX, originY, anchorX, anchorY;
				    	var shadowSize;
				    	var shadowOrigin, shadowAnchor;
				    	var shadowUrl = markerProps['shadow.url'];
				    	
				    	if(markerProps['shadow.width']) {
				    		width = new Number(markerProps['shadow.width']);
				    		height = 0;
				    	}
				    	if(markerProps['shadow.height']) {
				    		height = new Number(markerProps['shadow.height']);
				    		if(!width) {
				    			width = 0;
				    		}
				    	}
				    	if(markerProps['shadow.origin.x']) {
				    		originX = new Number(markerProps['shadow.origin.x']);
				    		originY = 0;
				    	}
				    	if(markerProps['shadow.origin.y']) {
				    		originY = new Number(markerProps['shadow.origin.y']);
				    		if(!originX) {
				    			originX = 0;
				    		}
				    	}
				    	if(markerProps['shadow.anchor.x']) {
				    		anchorX = new Number(markerProps['shadow.anchor.x']);
				    		anchorY = 0;
				    	}
				    	if(markerProps['shadow.anchor.y']) {
				    		anchorY = new Number(markerProps['shadow.anchor.y']);
				    		if(!anchorX) {
				    			anchorX = 0;
				    		}
				    	}
			    		if(width || height) {
			    			shadowSize = new google.maps.Size(width,height);
			    		}
			    		if(originX || originY) {
			    			shadowOrigin = new google.maps.Point(originX,originY);
			    		}
			    		if(anchorX || anchorY) {
			    			shadowAnchor = new google.maps.Point(anchorX,anchorY);
			    		}
			    		var customShadow = {
				    		url: shadowUrl,
				    		size: shadowSize,
				    		origin: shadowOrigin,
				    		anchor: shadowAnchor
				    	};
				    	markerOptions['shadow'] = customShadow;
				    }
				    
				    for (j in markerProps) {
						if (
							j.indexOf("icon.") < 0 
							&& j.indexOf("shadow.") < 0
							&& markerProps.hasOwnProperty(j) 
							&& !markerOptions.hasOwnProperty(j)
							) {
								markerOptions[j] = markerProps[j];
						}
					}
				    var marker = new google.maps.Marker(markerOptions);
				}
			}
		}());		
	</script>
#end